doctype html
html
  head
    title Finance
    meta(name='viewport', content='user-scalable=no, width=device-width, initial-scale=1.0, maximum-scale=1.0')
    meta(name='mobile-web-app-capable', content='yes')
    meta(name='apple-mobile-web-app-capable', content='yes')
    
    style
      :stylus
        form
          display flex
          flex-flow row wrap
      
        fieldset
          label
            margin 3px 0
            
            //display flex
            //align-items baseline
            //justify-content space-between
            display block
            text-align right
            
            input
              width 70%
              margin-left 5px
              
          button
            display block
            margin-left auto
        
        #dbdump
          
          .del
            color red
            font-weight bold
            cursor pointer
            &::before
              content " X"
  body
    //
      form
        fieldset
          legend Create Account
          label
            | Name
            input#ca-name
          button#ca-btn(type='button') Create
      
        datalist#accts
          option(value='Cash')
          option(value='Savings')
        
        fieldset
          legend Create transaction
          label
            | From
            input#ct-from(list='accts')
          label
            | To
            input#ct-to(list='accts')
          label
            | Amount
            input#ct-amt(type='number')
          button#ct-btn(type='button') Create
      
      pre#dbdump
    
    script(src='pouchdb/pouchdb.min.js')
    script(src='jquery/jquery.min.js')
    script(src='underscore/underscore.js')
    script(src='mercury/mercury.js')
    
    script
      :livescript
        {h} = hg = mercury
        log = console~log
        db = new PouchDB \finance
        
        res <- db.allDocs { +include_docs } .catch log .then
        
        dump-state = hg.array res.rows.map -> hg.struct it.doc
        
        del = (s, d) ->
          db.remove d .catch log
          # optimistically update local state?
          s.dump-state
            ..set ..!filter (._id != d._id)
        
        app-state = hg.state {
          dump-state,
          channels: {
            del
          }
        }
        
        lbl = (n, c) ->
          h \label [n, h c]
        
        var forms
        hg.app(
          $ \body .0
          app-state,
          (s) ->
            chs = s.channels
            forms ?:= [
            * h \fieldset [
                h \legend 'Create Account'
                lbl 'Name' \input#ca-name
                h \button#ca-btn {
                  type: \button
                  \ev-click : hg.send chs.addAcct
                  } 'Create'
              ]
            * h \fieldset [
                h \legend 'Create transaction'
                lbl 'From' \input#ct-from attributes: list: 'accts'
                lbl 'To' \input#ct-to attributes: list: 'accts'
                lbl 'Amount' \input#ct-amt type: 'number'
                h \button#ct-btn {type:\button} 'Create'
              ]
            ]
            
            h \div [
            * h \form [
                forms
                h \datalist#accts [
                  h \option {value: 'Cash'}
                  h \option {value: 'Savings'}
                ]
              ]
            * h \pre#dbdump (s.dump-state.map ->
                h \div [
                  (JSON.stringify it, null 2),
                  h \span.del 'ev-click': hg.send s.channels.del, it
                ])
            ]
        )
        
        # h('div', [h('form', [forms, h('datalist#accts')], h('pre#dbdump', s.dumpState))]);
        
        #$ \#ca-btn .click !->
        #  db.put {
        #    _id: 'acct-' + $ \#ca-name .val!
        #  }
        #
        #db.changes { +live, since: \now } .on \change dump-db
        